import type { NextPage } from "next";
import Head from "next/head";
import styles from "../styles/Home.module.css";
import Button from "@mui/material/Button";
import { useEffect } from "react";
import { CANDIDATE_ID } from "../src/constants";

type Position = {
  row: string;
  column: string;
};
const Home: NextPage = () => {
  const rowsNumberPhase1 = 11;
  const columnsNumberPhase1 = 11;
  const rows = Array.from(Array(rowsNumberPhase1).keys());
  const cols = Array.from(Array(columnsNumberPhase1).keys());
  const startRow = 2;
  const startColumn = 2;

  const getAllPositions = () => {
    const posList: Position[] = [];
    rows.forEach((row) => {
      cols.forEach((col) => {
        const pos: Position = { row: `${row}`, column: `${col}` };
        posList.push(pos);
      });
    });
    return posList;
  };

  const getPolyanetPositions = () => {
    const posList: Position[] = [];
    const stopRow = rows.length - 1 - startRow;
    console.log(stopRow);
    rows.forEach((row) => {
      if (row >= startRow && row <= stopRow) {
        cols.forEach((col) => {
          if (col >= startRow && col <= stopRow) {
            const pos1: Position = { row: `${row}`, column: `${col}` };
            if (col === row) {
              posList.push(pos1);
              const colInvert = 10 - col;
              const pos2: Position = { row: `${row}`, column: `${colInvert}` };
              posList.push(pos2);
            }
          }
        });
      }
    });

    return posList;
  };

  const createPolyanet = async () => {
    const posList = getPolyanetPositions();
    console.log(posList);
    const promises = posList.map((pos) => {
      return fetch("/api/polyanets/create", {
        method: "POST",
        body: JSON.stringify({
          candidateId: CANDIDATE_ID,
          row: `${pos.row}`,
          column: `${pos.column}`,
        }),
      });
    });

    try {
      const results = await Promise.allSettled(promises);

      results.forEach((res, index) => {
        if (res.status !== "fulfilled") {
          console.log(`Failed to Create at position ${index}`);
        }
      });
      console.log("Successfully created polyanets");
    } catch (error) {
      console.error(error);
    }
  };

  const deletePolyanets = async () => {
    const posList = getAllPositions();
    const promises = posList.map((pos) => {
      return fetch("/api/polyanets/delete", {
        method: "POST",
        body: JSON.stringify({
          candidateId: CANDIDATE_ID,
          row: `${pos.row}`,
          column: `${pos.column}`,
        }),
      });
    });

    try {
      const results = await Promise.allSettled(promises);

      results.forEach((res, index) => {
        if (res.value.status !== 200) {
          console.log(`Failed to Delete at position ${index}`);
        }
      });

      console.log("Successfully deleted polyanets");
    } catch (error) {
      console.error(error);
    }
  };

  useEffect(() => {
    async function fetchMap() {
      try {
        const res = await fetch("/api/map", {
          method: "GET",
        });

        const json = await res.json();
        console.log(json);
      } catch (error) {
        console.error(error);
      }
    }
    fetchMap();
  }, []);

  return (
    <div className={styles.container}>
      <Head>
        <title>Megaverse challenge | Anum </title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <h1 className={styles.title}>Welcome to Megaverse Challenge!</h1>
        <h3 className={styles.subtitle}>Completed by Anum</h3>

        <div className={styles.grid}>
          <div className={styles.card}>
            <h2>Phase1</h2>
            <p>Click the button below to create Polyanet Cross</p>
            <br />
            <div>
              <Button variant="outlined" onClick={createPolyanet}>
                Create
              </Button>
            </div>
            <div>
              <Button variant="outlined" onClick={deletePolyanets}>
                Reset Map
              </Button>
            </div>
          </div>
        </div>
      </main>

      <footer className={styles.footer}></footer>
    </div>
  );
};

export default Home;
